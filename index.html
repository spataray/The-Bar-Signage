<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>T.A. Station - Digital Signage</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <div id="status-indicator">KARAOKE LOCKED</div>

    <div id="app-container">
        <div id="video-section">
            <div id="player"></div>
        </div>

        <div id="ad-sidebar">
            <h2 id="ad-title">T.A. Station</h2>
            <p id="ad-desc"></p>
            <img id="ad-flyer" alt="Event Flyer">
            <div class="menu-section" id="menu-content"></div>
        </div>
    </div>

    <div id="ticker-container">
        <div class="ticker-wrap">
            <span id="ticker-text"></span>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // 1. DATA SOURCES
        const URL_ADS = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSY_76oR-biNXkDm9_MUA-RjKm-DBkeaAX903MPQJHMd2Ku_HFj2Z8w8xDIA-mxl7-Bf474N7MlKdYY/pub?gid=572262531&single=true&output=csv";
        const URL_MENU = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSY_76oR-biNXkDm9_MUA-RjKm-DBkeaAX903MPQJHMd2Ku_HFj2Z8w8xDIA-mxl7-Bf474N7MlKdYY/pub?gid=1406308889&single=true&output=csv";
        const URL_TICKER = "https://docs.google.com/spreadsheets/d/e/2PACX-1vSY_76oR-biNXkDm9_MUA-RjKm-DBkeaAX903MPQJHMd2Ku_HFj2Z8w8xDIA-mxl7-Bf474N7MlKdYY/pub?gid=1639387472&single=true&output=csv";

        // 2. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyByZx_LjyqpqOl90XMZFWy4eHBQJklCooc",
            authDomain: "ta-station-remote.firebaseapp.com",
            databaseURL: "https://ta-station-remote-default-rtdb.firebaseio.com",
            projectId: "ta-station-remote",
            storageBucket: "ta-station-remote.firebasestorage.app",
            messagingSenderId: "805160829750",
            appId: "1:805160829750:web:9a2a9e1cbf639562aba997"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        var player;
        var playerReady = false;
        var pendingVideoId = null;
        var isLocked = false;

        // 3. YOUTUBE SETUP
        function onYouTubeIframeAPIReady() {
            player = new YT.Player('player', {
                playerVars: { autoplay: 1, controls: 1, rel: 0, enablejsapi: 1 },
                events: {
                    onReady: onPlayerReady,
                    onStateChange: onPlayerStateChange,
                    onError: onPlayerError
                }
            });
        }

        function onPlayerReady() {
            playerReady = true;
            if (pendingVideoId) {
                player.loadVideoById(pendingVideoId);
                pendingVideoId = null;
            }
        }

        function onPlayerError(event) {
            // 101/150 = embedding disabled, 100 = not found
            console.warn('Player error:', event.data, '— skipping to next');
            playNext();
        }

        function onPlayerStateChange(event) {
            if (event.data === YT.PlayerState.PLAYING) {
                reportNowPlaying();
            }
            if (event.data === YT.PlayerState.ENDED) {
                playNext();
            }
            db.ref('settings/playerState').set(event.data);
        }

        function reportNowPlaying() {
            if (!player || !player.getVideoData) return;
            var data = player.getVideoData();
            if (data.video_id) {
                db.ref('settings/nowPlaying').set({
                    videoId: data.video_id,
                    title: data.title || '',
                    author: data.author || ''
                });
            }
        }

        function playNext() {
            db.ref('settings/queue').once('value', function(snap) {
                var queue = snap.val() || [];
                if (queue.length > 0) {
                    var next = queue[0];
                    var remaining = queue.slice(1);
                    db.ref('settings/queue').set(remaining);
                    player.loadVideoById(next.id);
                }
            });
        }

        // 4. ASYNC CONTENT SYNC
        async function syncContent() {
            try {
                // Sync Ads
                const adRes = await fetch(URL_ADS);
                const adText = await adRes.text();
                const adRows = adText.split('\n').map(r => r.split(','));
                document.getElementById('ad-title').innerText = adRows[0][0] || "T.A. Station";
                document.getElementById('ad-desc').innerText = adRows[1][0] || "";
                if(adRows[2] && adRows[2][0].includes('http')) {
                    document.getElementById('ad-flyer').src = adRows[2][0].trim();
                }

                // Sync Menu
                const menuRes = await fetch(URL_MENU);
                const menuText = await menuRes.text();
                const menuRows = menuText.split('\n').map(r => r.split(','));
                let menuHtml = "<h3>DRINKS & PUPUS</h3>";
                menuRows.forEach(row => {
                    if(row[0] && row[0] !== "Item Name") {
                        menuHtml += `<div class="menu-item"><span>${row[0]}</span><span>${row[1] || ''}</span></div>`;
                    }
                });
                document.getElementById('menu-content').innerHTML = menuHtml;

                // Sync Ticker
                const tickRes = await fetch(URL_TICKER);
                const tickText = await tickRes.text();
                const tickRows = tickText.split('\n').map(r => r.trim()).filter(r => r.length > 0 && r !== "Message");
                document.getElementById('ticker-text').innerText = tickRows.join('   •   ');

            } catch (e) {
                console.error("Content Sync Failed:", e);
            }
        }

        // 5. FIREBASE LISTENERS
        db.ref('settings/currentVideoId').on('value', function(snap) {
            var vid = snap.val();
            if (!vid) return;
            if (playerReady) {
                player.loadVideoById(vid);
            } else {
                pendingVideoId = vid;
            }
        });

        db.ref('settings/playerCommand').on('value', function(snap) {
            var cmd = snap.val();
            if (!cmd || !player) return;
            switch (cmd.action) {
                case 'pause': player.pauseVideo(); break;
                case 'play': player.playVideo(); break;
                case 'next': playNext(); break;
                case 'volume': player.setVolume(cmd.value); break;
            }
            db.ref('settings/playerCommand').set(null);
        });

        db.ref('settings/partyMode').on('value', function(snap) {
            if (snap.val()) document.body.classList.add('party-mode');
            else document.body.classList.remove('party-mode');
        });

        db.ref('settings/remoteRefresh').on('value', function(snap) {
            if (snap.val()) {
                db.ref('settings/remoteRefresh').set(null);
                location.reload();
            }
        });

        // 6. START SYNC
        syncContent();
        setInterval(syncContent, 60000);
    </script>

</body>
</html>
